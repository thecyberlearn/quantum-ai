{% extends 'base.html' %}
{% load static %}

{% block title %}Job Posting Generator Agent - Quantum Tasks AI{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/agent-base.css' %}?v={{ timestamp }}">
{% endblock %}

{% block content %}
<script>
    // Set user authentication status for JavaScript access
    document.addEventListener('DOMContentLoaded', function() {
        document.body.setAttribute('data-user-authenticated', '{{ user.is_authenticated|yesno:"true,false" }}');
        document.body.setAttribute('data-login-url', '{% url "authentication:login" %}');
        document.body.setAttribute('data-wallet-url', '{% url "wallet:wallet" %}');
        
        // Initialize agent configuration
        window.AGENT_PRICE = {{ agent.price }};
    });
</script>
<script>
        // Agent Frontend Template - Common JavaScript Utilities

        // Quick Agent Access Panel Functions
        function toggleQuickAgents() {
            const panel = document.getElementById('quickAgentsPanel');
            const overlay = document.getElementById('quickAgentsOverlay');
            const toggle = document.querySelector('.quick-agent-toggle');
            
            const isActive = panel.classList.contains('active');
            
            if (isActive) {
                // Close panel
                panel.classList.remove('active');
                overlay.classList.remove('active');
                toggle.classList.remove('active');
                toggle.setAttribute('aria-expanded', 'false');
                panel.setAttribute('aria-hidden', 'true');
                overlay.setAttribute('aria-hidden', 'true');
                document.body.style.overflow = 'auto';
            } else {
                // Open panel
                panel.classList.add('active');
                overlay.classList.add('active');
                toggle.classList.add('active');
                toggle.setAttribute('aria-expanded', 'true');
                panel.setAttribute('aria-hidden', 'false');
                overlay.setAttribute('aria-hidden', 'false');
                document.body.style.overflow = 'hidden';
            }
        }

        function closeQuickAgents() {
            const panel = document.getElementById('quickAgentsPanel');
            const overlay = document.getElementById('quickAgentsOverlay');
            const toggle = document.querySelector('.quick-agent-toggle');
            
            if (panel && overlay && toggle) {
                panel.classList.remove('active');
                overlay.classList.remove('active');
                toggle.classList.remove('active');
                toggle.setAttribute('aria-expanded', 'false');
                panel.setAttribute('aria-hidden', 'true');
                overlay.setAttribute('aria-hidden', 'true');
                document.body.style.overflow = 'auto';
            }
        }

        // Toast Notification Function
        function showToast(message, type = 'info') {
            // Remove existing toasts
            document.querySelectorAll('.toast').forEach(toast => toast.remove());
            
            // Create new toast
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            // Add to page
            document.body.appendChild(toast);
            
            // Show toast with animation
            setTimeout(() => toast.classList.add('show'), 100);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Processing Status Functions
        function showProcessing() {
            const processingStatus = document.getElementById('processingStatus');
            processingStatus.style.display = 'block';
            processingStatus.classList.add('active');
        }

        function hideProcessing() {
            const processingStatus = document.getElementById('processingStatus');
            processingStatus.style.display = 'none';
            processingStatus.classList.remove('active');
        }

        // Wallet Balance Update Function
        function updateWalletBalance(newBalance) {
            if (newBalance !== undefined) {
                const walletBalance = document.getElementById('walletBalance');
                if (walletBalance) {
                    walletBalance.textContent = newBalance.toFixed(2);
                }
            }
        }

        // Copy to Clipboard Utility
        function copyToClipboard(text, successMessage = 'Copied to clipboard!') {
            navigator.clipboard.writeText(text).then(() => {
                showToast(`üìã ${successMessage}`, 'success');
            }).catch(() => {
                showToast('Failed to copy to clipboard', 'error');
            });
        }

        // Download as File Utility
        function downloadAsFile(text, filename, successMessage = 'File downloaded!') {
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename || `content-${Date.now()}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            showToast(`üíæ ${successMessage}`, 'success');
        }

        // Close panel on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeQuickAgents();
            }
        });

        // Initialize accessibility features
        document.addEventListener('DOMContentLoaded', function() {
            // Set initial ARIA states
            const quickAgentsButton = document.querySelector('.quick-agent-toggle');
            if (quickAgentsButton) {
                quickAgentsButton.setAttribute('aria-expanded', 'false');
            }
            
            const panel = document.getElementById('quickAgentsPanel');
            const overlay = document.getElementById('quickAgentsOverlay');
            if (panel) panel.setAttribute('aria-hidden', 'true');
            if (overlay) overlay.setAttribute('aria-hidden', 'true');
        });

        // Job Posting specific utilities
        const JobPostingUtils = {
            renderSecureContent(container, content) {
                // Secure rendering without innerHTML
                const wrapper = document.createElement('div');
                wrapper.className = 'results-content';
                
                // Basic text processing for job postings
                const lines = content.split('\n');
                lines.forEach(line => {
                    if (line.trim()) {
                        const p = document.createElement('p');
                        p.textContent = line.trim();
                        wrapper.appendChild(p);
                    }
                });
                
                container.appendChild(wrapper);
            },

            copyJobPosting() {
                const content = document.getElementById('jobContent');
                if (content) {
                    const text = content.textContent || content.innerText || '';
                    copyToClipboard(text, 'Job posting copied to clipboard!');
                }
            },

            downloadJobPosting() {
                const content = document.getElementById('jobContent');
                if (content) {
                    const text = content.textContent || content.innerText || '';
                    downloadAsFile(text, `job-posting-${Date.now()}.txt`, 'Job posting downloaded!');
                }
            }
        };
</script>
<div class="agent-container">
    <!-- Agent Header -->
    {% include "components/agent_header.html" with agent_title="Job Posting Generator" agent_subtitle="Create professional job postings with AI-powered content generation" %}

    <!-- Quick Agent Access Panel -->
    {% include "components/quick_agents_panel.html" %}

        <!-- Messages -->
        {% if messages %}
            {% for message in messages %}
                <div class="{% if message.tags == 'error' %}alert alert-error{% else %}alert{% endif %}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}

        <!-- Agent Grid -->
        <div class="agent-grid">
            <div class="agent-widget widget-large" style="flex: 1; margin-right: var(--spacing-lg);">
                <div class="widget-header">
                    <h3 class="widget-title">
                        <span class="widget-icon">üìù</span>
                        Job Posting Form
                    </h3>
                </div>
                <div class="widget-content">
                
                    <form method="POST" id="jobPostingForm">
                        {% csrf_token %}
                        
                        <div class="form-group">
                            <label class="form-label" for="job_title">Job Title *</label>
                            <input type="text" name="job_title" id="job_title" class="form-input" placeholder="e.g., Senior Software Engineer" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="company_name">Company Name *</label>
                            <input type="text" name="company_name" id="company_name" class="form-input" placeholder="e.g., TechCorp Inc." required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="job_description">Job Description *</label>
                            <textarea name="job_description" id="job_description" class="form-textarea" placeholder="Describe the role, requirements, and company culture" rows="4" required></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="seniority_level">Seniority Level *</label>
                            <select name="seniority_level" id="seniority_level" class="form-input" required>
                                <option value="">Select level...</option>
                                <option value="entry">Entry Level</option>
                                <option value="mid">Mid Level</option>
                                <option value="senior">Senior Level</option>
                                <option value="lead">Lead/Principal</option>
                                <option value="executive">Executive</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="contract_type">Contract Type *</label>
                            <select name="contract_type" id="contract_type" class="form-input" required>
                                <option value="">Select type...</option>
                                <option value="full-time">Full-time</option>
                                <option value="part-time">Part-time</option>
                                <option value="contract">Contract</option>
                                <option value="freelance">Freelance</option>
                                <option value="internship">Internship</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="location">Location *</label>
                            <input type="text" name="location" id="location" class="form-input" placeholder="e.g., Dubai, UAE or Remote" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="language">Language</label>
                            <select name="language" id="language" class="form-input">
                                <option value="English">English</option>
                                <option value="Arabic">Arabic</option>
                                <option value="Spanish">Spanish</option>
                                <option value="French">French</option>
                                <option value="German">German</option>
                            </select>
                        </div>
                        
                        {% if user.is_authenticated %}
                            {% if user.wallet_balance >= agent.price %}
                                <button type="submit" class="btn btn-primary btn-full" id="processButton">
                                    üíº Generate Job Posting ({{ agent.price }} AED)
                                </button>
                            {% else %}
                                <div class="alert alert-error">
                                    Insufficient balance! You need {{ agent.price }} AED.
                                </div>
                                <a href="{% url 'wallet:wallet' %}" class="btn btn-primary btn-full">
                                    üí∞ Top Up Wallet
                                </a>
                            {% endif %}
                        {% else %}
                            <a href="{% url 'authentication:login' %}" class="btn btn-primary btn-full">
                                üîë Login to Continue
                            </a>
                        {% endif %}
                    </form>
                </div>
            </div>

            <!-- How It Works Widget -->
            <div class="agent-widget widget-small" style="min-width: min(280px, 100%); max-width: min(280px, 100%); margin-left: auto;">
                <div class="widget-header">
                    <h3 class="widget-title">
                        <span class="widget-icon">‚ÑπÔ∏è</span>
                        How It Works
                    </h3>
                </div>
                <div class="widget-content">
                    <ol class="info-list">
                        <li>Enter job requirements</li>
                        <li>Configure position details</li>
                        <li>Process with AI</li>
                        <li>Get professional posting</li>
                    </ol>
                    
                    <!-- Quick Agents Toggle Button -->
                    <button class="quick-agent-toggle" onclick="toggleQuickAgents()" 
                            title="Quick access to other agents"
                            aria-label="Open quick access panel for other AI agents"
                            aria-expanded="false"
                            aria-controls="quickAgentsPanel"
                            style="margin-top: var(--spacing-md);">
                        <span class="toggle-icon" aria-hidden="true">üöÄ</span>
                        <span class="toggle-text">Explore Other Agents</span>
                    </button>
                </div>
            </div>
        </div>

    <!-- Processing Status -->
    <div class="agent-grid">
        {% include "components/processing_status.html" with status_title="Creating Job Posting..." status_text="Please wait while we generate your professional job posting..." %}
    </div>

    <!-- Results -->
    <div class="agent-grid">
        {% include "components/results_container.html" with results_title="Generated Job Posting" %}
    </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
    // Form validation
    function isFormValid() {
        const required = ['job_title', 'company_name', 'job_description', 'seniority_level', 'contract_type', 'location'];
        return required.every(id => document.getElementById(id).value.trim());
    }

    // Display results
    function displayResults(result) {
        const resultsContainer = document.getElementById('resultsContainer');
        const contentElement = document.getElementById('resultsContent');
        
        if (result.wallet_balance !== undefined) {
            updateWalletBalance(result.wallet_balance);
        }
        
        if (result.error) {
            showToast(`‚ùå ${result.error}`, 'error');
            return;
        }
        
        let content = result.job_posting_content || result.content || 'Job posting generated successfully!';
        if (contentElement) {
            contentElement.innerHTML = `<pre style="white-space: pre-wrap; word-wrap: break-word;">${content}</pre>`;
        }
        
        if (resultsContainer) {
            resultsContainer.style.display = 'block';
            resultsContainer.scrollIntoView({ behavior: 'smooth' });
        }
        showToast('‚úÖ Job posting created successfully!', 'success');
    }

    // Poll for results
    function pollForResults(requestId) {
        let pollCount = 0;
        const maxPolls = 30; // 30 seconds max
        
        console.log(`Starting polling for request: ${requestId}`);
        
        const pollInterval = setInterval(() => {
            pollCount++;
            console.log(`Poll attempt ${pollCount}/${maxPolls} for request: ${requestId}`);
            
            fetch(`/agents/job-posting-generator/status/${requestId}/`)
                .then(response => {
                    console.log(`Status response: ${response.status}`);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    return response.json();
                })
                .then(result => {
                    console.log('Poll result:', result);
                    
                    if (result.status === 'completed') {
                        clearInterval(pollInterval);
                        hideProcessing();
                        document.getElementById('processButton').disabled = false;
                        displayResults(result);
                    } else if (result.status === 'failed') {
                        clearInterval(pollInterval);
                        hideProcessing();
                        document.getElementById('processButton').disabled = false;
                        showToast(`‚ùå Processing failed: ${result.error || 'Unknown error'}`, 'error');
                    } else if (pollCount >= maxPolls) {
                        clearInterval(pollInterval);
                        hideProcessing();
                        document.getElementById('processButton').disabled = false;
                        showToast('‚è∞ Processing is taking longer than expected. Please check back later.', 'error');
                    }
                    // Continue polling if status is 'processing' or 'pending'
                })
                .catch(error => {
                    console.error('Polling error:', error);
                    clearInterval(pollInterval);
                    hideProcessing();
                    document.getElementById('processButton').disabled = false;
                    showToast(`‚ùå Error checking status: ${error.message}`, 'error');
                });
        }, 1000);
    }

    // Handle form submission
    document.getElementById('jobPostingForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (!isFormValid()) {
            showToast('Please fill in all required fields', 'error');
            return;
        }
        
        const processButton = document.getElementById('processButton');
        if (processButton.disabled) return;
        
        const isAuthenticated = document.body.getAttribute('data-user-authenticated') === 'true';
        if (!isAuthenticated) {
            window.location.href = document.body.getAttribute('data-login-url');
            return;
        }
        
        const currentBalance = parseFloat(document.getElementById('walletBalance').textContent) || 0;
        const requiredBalance = window.AGENT_PRICE || 3.00;
        if (currentBalance < requiredBalance) {
            showToast(`Insufficient balance! You need ${requiredBalance} AED.`, 'error');
            setTimeout(() => window.location.href = document.body.getAttribute('data-wallet-url'), 2000);
            return;
        }

        showProcessing();
        processButton.disabled = true;
        const resultsContainer = document.getElementById('resultsContainer');
        if (resultsContainer) resultsContainer.style.display = 'none';
        
        fetch(window.location.href, {
            method: 'POST',
            body: new FormData(this),
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => response.json())
        .then(result => {
            if (result.success && result.request_id) {
                pollForResults(result.request_id);
            } else {
                hideProcessing();
                processButton.disabled = false;
                displayResults(result);
            }
        })
        .catch(error => {
            hideProcessing();
            processButton.disabled = false;
            showToast('‚ùå Network error', 'error');
        });
    });

    // Add functions expected by the results component
    function copyResults() {
        const content = document.getElementById('resultsContent');
        if (content) {
            const text = content.textContent || content.innerText || '';
            copyToClipboard(text, 'Job posting copied to clipboard!');
        }
    }

    function downloadResults() {
        const content = document.getElementById('resultsContent');
        if (content) {
            const text = content.textContent || content.innerText || '';
            downloadAsFile(text, `job-posting-${Date.now()}.txt`, 'Job posting downloaded!');
        }
    }

    function resetForm() {
        document.getElementById('jobPostingForm').reset();
        const resultsContainer = document.getElementById('resultsContainer');
        if (resultsContainer) resultsContainer.style.display = 'none';
        document.getElementById('processButton').disabled = false;
    }
</script>
{% endblock %}